<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Now & Next Display</title>
    <style>
        :root {
            --color-bg: #f4f7f6;
            --color-header-bg: #ffffff;
            --color-border: #e0e0e0;
            --color-text-primary: #2c3e50;
            --color-text-secondary: #5a7a9b;
            --color-text-header: #34495e;
            --color-now: #27ae60;
            --color-next: #2980b9;
            --color-break: #7f8c8d;
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        body {
            font-family: var(--font-main);
            background-color: var(--color-bg);
            color: var(--color-text-primary);
            margin: 0;
            padding: 16px;
        }
        
        h1 {
            color: var(--color-text-header);
            text-align: center;
            font-size: 2.0em;
            margin-bottom: 0;
        }

        #clock {
            text-align: center;
            font-size: 1.2em;
            color: var(--color-text-secondary);
            margin-bottom: 20px;
        }

        #week-display {
            text-align: center;
            font-size: 1.0em;
            font-weight: bold;
            color: var(--color-text-header);
            margin-bottom: 20px;
            margin-top: -16px;
        }
        
        #dashboard-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }
        
        .class-card {
            background-color: var(--color-header-bg);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--color-border);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .class-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--color-border);
        }
        
        .class-header h2 {
            margin: 0;
            font-size: 1.5em;
            color: var(--color-text-primary);
        }
        
        .class-body {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex-grow: 1;
        }
        
        .event {
            line-height: 1.4;
        }

        .event-type {
            font-weight: bold;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .event-type.now { color: var(--color-now); }
        .event-type.next { color: var(--color-next); }
        .event-type.break { color: var(--color-break); }
        
        .event-subject {
            font-size: 1.2em;
            font-weight: 600;
            margin: 2px 0;
        }
        
        .event-details {
            font-size: 0.9em;
            color: var(--color-text-secondary);
        }

        .event-none {
            font-size: 1.0em;
            color: var(--color-text-secondary);
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 40px;
        }

    </style>
</head>
<body>

    <h1>School Schedule</h1>
    <div id="clock">Loading...</div>
    <div id="week-display"></div>
    <div id="dashboard-container">
        </div>

    <script>
        // --- PASTE YOUR DATA HERE ---
        // Open your Lessons.txt file, copy ALL the text,
        // and paste it between the two backticks (` `) below.
        
        const tsvData = `PASTE_YOUR_DATA_FROM_LESSONS.TXT_HERE`;
        
        // --- END OF DATA ---


        /**
         * Converts a time string (HHMM) to total minutes from midnight.
         */
        function timeToMinutes(timeStr) {
            const hours = parseInt(timeStr.substring(0, 2), 10);
            const minutes = parseInt(timeStr.substring(2, 4), 10);
            return (hours * 60) + minutes;
        }

        /**
         * Formats total minutes from midnight to a HH:MM string.
         */
        function minutesToTime(totalMinutes) {
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        }

        /**
         * Gets the current ISO week number for a given date.
         * @param {Date} date - The date object to check.
         * @returns {number} - The ISO week number.
         */
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            // Set to nearest Thursday: current date + 4 - current day number
            // Make Sunday's day number 7
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            // Get first day of year
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            // Calculate full weeks to nearest Thursday
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return weekNo;
        }
        
        /**
         * Parses week range strings into an array of numbers.
         * e.g., "34-36, 40" -> [34, 35, 36, 40]
         * @param {string} rangeStr - The week range string.
         * @returns {Array<number>}
         */
        function parseWeekRanges(rangeStr) {
            const weeks = [];
            if (!rangeStr || rangeStr === "0") {
                return weeks;
            }
            
            const parts = rangeStr.split(',');
            for (const part of parts) {
                if (part.includes('-')) {
                    const [start, end] = part.split('-').map(Number);
                    for (let i = start; i <= end; i++) {
                        weeks.push(i);
                    }
                } else {
                    weeks.push(Number(part));
                }
            }
            return weeks;
        }

        /**
         * Parses the raw TSV data into a usable array of lesson objects.
         */
        function parseLessons(tsv) {
            const lessons = [];
            const lines = tsv.trim().split(/[\r\n]+/);
            
            if (lines.length < 2) {
                console.error("No data found or invalid data format.");
                return [];
            }
            
            const headers = lines[0].split('\t').map(h => h.trim());
            
            const colIdx = {
                group: headers.indexOf('group'),
                subject: headers.indexOf('subject'),
                day: headers.indexOf('day'),
                starttime: headers.indexOf('starttime'),
                length: headers.indexOf('length'),
                room: headers.indexOf('room'),
                realweeks: headers.indexOf('realweeks') // <-- NEW
            };

            for (const key in colIdx) {
                if (colIdx[key] === -1) {
                    console.error(`Error: Required column "${key}" not found in data.`);
                    alert(`Error: Data file is missing required column "${key}".`);
                    return [];
                }
            }

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split('\t');
                if (values.length < headers.length) continue;

                const day = values[colIdx.day].trim();
                const startTimeStr = values[colIdx.starttime].trim().padStart(4, '0');
                const length = parseInt(values[colIdx.length], 10);
                
                if (!["Mon", "Tue", "Wed", "Thu", "Fri"].includes(day) || !startTimeStr || length <= 0) {
                    continue;
                }

                const startTime = timeToMinutes(startTimeStr);
                const lesson = {
                    group: values[colIdx.group].trim(),
                    subject: values[colIdx.subject].trim(),
                    day: day,
                    room: values[colIdx.room].trim(),
                    startTime: startTime,
                    endTime: startTime + length,
                    startTimeStr: minutesToTime(startTime),
                    endTimeStr: minutesToTime(startTime + length),
                    validWeeks: parseWeekRanges(values[colIdx.realweeks]) // <-- NEW
                };

                if (lesson.group) {
                    const groups = lesson.group.split(',');
                    for (const g of groups) {
                        const trimmedGroup = g.trim();
                        if (trimmedGroup) {
                            lessons.push({ ...lesson, group: trimmedGroup });
                        }
                    }
                }
            }
            return lessons;
        }

        /**
         * Gets the current "Now" and "Next" lessons for a specific class.
         */
        function getNowAndNext(allLessons, className, nowDay, nowMinutes, currentWeek) {
            const dayMap = ["", "Mon", "Tue", "Wed", "Thu", "Fri"];
            const currentDayStr = dayMap[nowDay];

            if (!currentDayStr) {
                return { now: null, next: null }; // Weekend
            }

            // Get all lessons for this class today, FOR THIS WEEK
            const todayLessons = allLessons
                .filter(l => 
                    l.group === className && 
                    l.day === currentDayStr &&
                    l.validWeeks.includes(currentWeek) // <-- NEW FILTER
                )
                .sort((a, b) => a.startTime - b.startTime);

            let now = null;
            let next = null;

            for (const lesson of todayLessons) {
                if (nowMinutes >= lesson.startTime && nowMinutes < lesson.endTime) {
                    now = lesson;
                }
                if (lesson.startTime > nowMinutes) {
                    if (!next) { // Only grab the very first "next" lesson
                        next = lesson;
                    }
                }
            }
            
            // If "Now" was found, "Next" must be after "Now" ends
            if (now) {
                next = null; // Reset next, find the one after 'now' ends
                for (const lesson of todayLessons) {
                    if (lesson.startTime >= now.endTime) {
                         next = lesson;
                         break;
                    }
                }
            }

            return { now, next };
        }

        /**
         * Creates the HTML for a single lesson event.
         */
        function createEventHTML(lesson, type) {
            if (!lesson) {
                if (type === 'now') {
                    return `
                        <div class="event">
                            <div class="event-type break">Now</div>
                            <div class="event-subject">Break / Lunch</div>
                            <div class="event-details">No class scheduled</div>
                        </div>`;
                } else {
                     return `
                        <div class="event">
                            <div class="event-type break">Next</div>
                            <div class="event-subject">End of Day</div>
                            <div class="event-details">No more classes scheduled</div>
                        </div>`;
                }
            }
            
            const location = lesson.room ? `(${lesson.room})` : '';
            const timeDetails = type === 'now' 
                ? `Ends at ${lesson.endTimeStr}` 
                : `Starts at ${lesson.startTimeStr}`;

            return `
                <div class="event">
                    <div class="event-type ${type}">${type}</div>
                    <div class="event-subject">${lesson.subject} ${location}</div>
                    <div class.event-details">${timeDetails}</div>
                </div>`;
        }

        /**
         * Main function to update the dashboard.
         */
        function updateDashboard() {
            const allLessons = parseLessons(tsvData);
            if (allLessons.length === 0) {
                 document.getElementById('dashboard-container').innerHTML = 
                    "<h2>Error: Could not load lesson data.</h2><p>Please make sure you have pasted the data from Lessons.txt correctly into the `index.html` file.</p>";
                 document.getElementById('clock').innerHTML = "Error";
                return;
            }

            const classNames = [...new Set(allLessons.map(l => l.group))]
                .filter(name => /^[4-9][A-Z]$/.test(name)) 
                .sort();
            
            const container = document.getElementById('dashboard-container');
            container.innerHTML = ''; 
            
            // Get current time in Stockholm
            const now = new Date(new Date().toLocaleString("en-US", {timeZone: "Europe/Stockholm"}));
            const nowDay = now.getDay(); 
            const nowMinutes = (now.getHours() * 60) + now.getMinutes();
            const currentWeek = getWeekNumber(now); // <-- NEW

            // Update clock and week display
            const clockEl = document.getElementById('clock');
            const weekEl = document.getElementById('week-display'); // <-- NEW
            const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            
            clockEl.innerHTML = `${dayNames[nowDay]}, ${minutesToTime(nowMinutes)}`;
            weekEl.innerHTML = `Displaying Schedule for: Week ${currentWeek}`; // <-- NEW

            if (nowDay === 0 || nowDay === 6) {
                container.innerHTML = "<h2>It's the weekend.</h2>";
                return;
            }

            // Generate a card for each class
            for (const className of classNames) {
                const { now: nowLesson, next: nextLesson } = getNowAndNext(allLessons, className, nowDay, nowMinutes, currentWeek); // <-- Pass currentWeek
                
                const card = document.createElement('div');
                card.className = 'class-card';
                
                card.innerHTML = `
                    <div class="class-header">
                        <h2>${className}</h2>
                    </div>
                    <div class="class-body">
                        ${createEventHTML(nowLesson, 'now')}
                        ${createEventHTML(nextLesson, 'next')}
                    </div>
                `;
                container.appendChild(card);
            }
        }

        // --- Run the application ---
        
        // Run once on load
        updateDashboard();
        
        // Refresh every 30 seconds
        setInterval(updateDashboard, 30000); 

    </script>
</body>
</html>
